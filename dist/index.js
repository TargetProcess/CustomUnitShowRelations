tau.mashups.addModule("CustomUnitShowRelations/config", {});
/*! v0.1.0 Build Wed Sep 30 2015 12:32:45 GMT+0300 (MSK) */
!function(){var t={},e=function(){var e,n,r,a=Array.prototype.slice.call(arguments,0);"string"==typeof a[0]?(r=a[0],e=a[1],n=a[2]):Array.isArray(a[0])&&(e=a[0],n=a[1]);var o=e.reduce(function(t,e){return t.addDependency(e)},tau.mashups);return o=o.addDependency(r+"/config"),o=o.addMashup(function(){var a=Array.prototype.slice.call(arguments,0);if(e.length>0&&1===a.length)throw new Error("Can't properly load dependencies for mashup \""+r+'", mashup is stopped.');return t.variables=a[a.length-1],a.length-e.length===2?t.config=a[a.length-2]:t.config={},Object.freeze&&(Object.freeze(t.variables),Object.freeze(t.config),Object.freeze(t)),n.apply(null,a)})};e("CustomUnitShowRelations",["jQuery","tau/configurator","tau/models/board.customize.units/const.entity.types.names","tau/models/board.customize.units/const.card.sizes","tau/models/board.customize.units/board.customize.units.interaction"],function(e,n,r,a,o){return function(e){function n(t){if(r[t])return r[t].exports;var a=r[t]={exports:{},id:t,loaded:!1};return e[t].call(a.exports,a,a.exports,n),a.loaded=!0,a.exports}var r={};return n.m=e,n.c=r,n.p="",n.p=t.variables?t.variables.mashupPath:n.p,n(0)}([function(t,e,n){t.exports=n(2)},,function(t,e,n){"use strict";function r(t){return t&&t.__esModule?t:{"default":t}}var a=n(3),o=r(a),i=n(4),s=r(i),u=n(5),l=r(u);n(12);var d=void 0,c=void 0,p=void 0,f="http://www.w3.org/2000/svg",h=void 0,m=void 0,v=function(t,e){var n=t.x1,r=t.x2,a=t.y1,o=t.y2,i=e.x1,s=e.x2,u=e.y1,l=e.y2,d=(a*(l-u)*(r-n)-u*(o-a)*(s-i)+(i-n)*(l-u)*(o-a))/((l-u)*(r-n)-(o-a)*(s-i)),c=(n*(s-i)*(o-a)-i*(r-n)*(l-u)+(u-a)*(s-i)*(r-n))/((s-i)*(o-a)-(r-n)*(l-u));return{x:c,y:d}},y=function(t){return[{x1:t.x,y1:t.y,x2:t.x+t.width,y2:t.y},{x1:t.x+t.width,y1:t.y,x2:t.x+t.width,y2:t.y+t.height},{x1:t.x,y1:t.y+t.height,x2:t.x+t.width,y2:t.y+t.height},{x1:t.x,y1:t.y,x2:t.x,y2:t.y+t.height}]},g=function(t,e,n){var r=t.x>=Math.min(e.x1,e.x2)&&t.x<=Math.max(e.x1,e.x2),a=t.x>=Math.min(n.x1,n.x2)&&t.x<=Math.max(n.x1,n.x2),o=t.y>=Math.min(e.y1,e.y2)&&t.y<=Math.max(e.y1,e.y2),i=t.y>=Math.min(n.y1,n.y2)&&t.y<=Math.max(n.y1,n.y2);return r&&a&&o&&i},x=function(t,e){var n=y(t),r=void 0;return n.forEach(function(t){var n=v(t,e);g(n,e,t)&&(r=n)}),r},b=function(t,e){var n={x1:t.x+t.width/2,y1:t.y+t.height/2,x2:e.x+e.width/2,y2:e.y+e.height/2};return{start:x(t,n),end:x(e,n)}},w=function(t){return o["default"].ajax({url:s["default"].getApplicationPath()+"/api/v1/generals/"+t+"?include=[MasterRelations[Master,RelationType],SlaveRelations[Slave,RelationType]]&format=json",contentType:"application/json; charset=utf-8"}).then(function(t){var e=t.MasterRelations.Items.map(function(t){return{directionType:"master",relationType:{name:t.RelationType.Name},entity:{id:t.Master.Id}}}).concat(t.SlaveRelations.Items.map(function(t){return{directionType:"slave",relationType:{name:t.RelationType.Name},entity:{id:t.Slave.Id}}}));return e}).fail(function(){})},C=function(t,e){var n=["M"+t.x+","+t.y],r=(t.x+e.x)/2,a=(t.y+e.y)/2,o=1*r+","+1.01*a;return n=n.concat("C"+o),n=n.concat(o),n.concat(e.x+","+e.y).join(" ")},R=function(t,e){var n=t.getBoundingClientRect(),r=e.getBoundingClientRect(),a=c[0].getBoundingClientRect(),o={x:n.left-a.left,y:n.top-a.top,height:n.height,width:n.width},i={x:r.left-a.left,y:r.top-a.top,height:r.height,width:r.width},s=b(o,i);if(h){var u=500*Math.random()*(Math.random()>.5?1:-1);s.start.x=s.start.x+u,s.end.x=s.end.x+u}var l=document.createElementNS(f,"path");l.setAttributeNS(null,"d",C(s.start,s.end)),l.setAttributeNS(null,"stroke","purple"),l.setAttributeNS(null,"fill","none"),l.setAttributeNS(null,"stroke-width","2"),l.setAttributeNS(null,"marker-end","url(#end)"),l.setAttributeNS(null,"marker-start","url(#start)"),p[0].appendChild(l)},S=function(t){var e=o["default"](".i-role-card[data-entity-id="+t.entity.id+"]");e.length&&(e.addClass("mashupCustomUnitShowRelations__related"),e.addClass("master"===t.directionType?"mashupCustomUnitShowRelations__related-inbound":"mashupCustomUnitShowRelations__related-outbound"),e.each(function(e,n){"master"===t.directionType?R(n,d[0]):R(d[0],n)}))},U=function(){var t=o["default"](".i-role-grid");t.removeClass("mashupCustomUnitShowRelations"),t.find(".i-role-card").removeClass("mashupCustomUnitShowRelations__related"),t.find(".i-role-card").removeClass("mashupCustomUnitShowRelations__related-inbound"),t.find(".i-role-card").removeClass("mashupCustomUnitShowRelations__related-outbound"),t.find(".i-role-card").removeClass("mashupCustomUnitShowRelations__source"),p.remove()},_=function(t,e){var n=o["default"](".i-role-grid");h=!1,c=n.children("table"),c.length||(c=n.find(".i-role-list-root-container"),h=!0);var r=c.height(),a=c.width();n.addClass("mashupCustomUnitShowRelations"),p=o["default"]('\n        <svg xmlns="http://www.w3.org/2000/svg" class="mashupCustomUnitShowRelations__svg" fill="pink" viewBox="0 0 '+a+" "+r+'" width="'+a+'px" height="'+r+'px">\n            <defs>\n                <marker id="start" markerWidth="7" markerHeight="7" refX="5" refY="5">\n                    <circle cx="5" cy="5" r="2" style="stroke: none; fill:purple;"/>\n                </marker>\n                <marker id="end" markerWidth="4" markerHeight="4" orient="auto" refY="2">\n                    <path d="M0,0 L4,2 0,4" fill="purple" />\n                </marker>\n            </defs>\n        </svg>'),p.on("click",U),d=n.find(".i-role-card[data-id="+t+"]"),d.addClass("mashupCustomUnitShowRelations__source"),h?n.find(".i-role-unit-editor-popup-position-within").append(p):n.append(p),e.forEach(S)};l["default"].customUnits.add({id:"my_entity_state",name:"show relations",template:'<div class="tau-board-unit__value"><button type="button" class="cu-showrelations">Show relations</button></div>',hideIf:function(t){var e=t.masterRelations,n=t.slaveRelations;return!e.items.length&&!n.items.length},model:{masterRelations:"MasterRelations",slaveRelations:"SlaveRelations"},sampleData:{masterRelations:[],slaveRelations:[]}}),o["default"](document.body).on("click",".cu-showrelations",function(t){t.stopPropagation(),t.preventDefault();var e=o["default"](t.target).parents(".i-role-card").data("entityId");m=o["default"](t.target).parents(".i-role-card").data("id"),w(e).then(function(t){return _(m,t)})})},function(t,n){t.exports=e},function(t,e){t.exports=n},function(t,e,n){"use strict";var r=n(6),a=n(7),o=n(8);t.exports={addBusListener:a.addBusListener,addBusListenerOnce:a.addBusListenerOnce,getAppConfigurator:r.getAppConfigurator,configurator:r,events:a,customUnits:o}},function(t,e,n){"use strict";var r=n(4),a=n(3),o=new a.Deferred;r.getGlobalBus().once("configurator.ready",function(t,e){o.resolve(e)});var i=function(){return o.promise()};t.exports={getAppConfigurator:i}},function(t,e,n){"use strict";var r=n(4),a=r.getBusRegistry(),o=function(t){return function(){t.apply(null,Array.prototype.slice.call(arguments).slice(1))}},i=function(t,e,n,r){var i=o(function(a){var o=a.bus;o.name===t&&o[r?"once":"on"](e,n)}),s=a.addEventListener("create",i);return a.addEventListener("destroy",o(function(r){var a=r.bus;a.name===t&&a.removeListener(e,n,s)})),{remove:function(){a.removeListener("create",i,s),a.getBusRegistry().getByName(t).then(function(t){t.removeListener(e,n,s)})}}},s=function(t,e,n){return i(t,e,n,!0)};t.exports={addBusListener:i,addBusListenerOnce:s}},function(t,e,n){"use strict";var r=n(9),a=n(10),o=n(11).openUnitEditor,i=n(6),s=function(t){return t=t||{},t.types=t.types||[r.ANY_TYPE],t.sizes=t.sizes||Object.keys(a).map(function(t){return a[t]}),i.getAppConfigurator().then(function(e){var n=e.getUnitsRegistry();if(!t.id)throw new Error('Field "id" is required for custom unit config');if(n.units[t.id])throw new Error('Custom unit with id "'+t.id+'" has been already registered');t.name=t.name||t.id,t.model=t.model||t.sampleData?t.model:{dummy:1},"string"!=typeof t.model&&"object"==typeof t.model&&(t.model=Object.keys(t.model).reduce(function(e,n){return e.concat(n+":"+t.model[n])},[]).join(", ")),t.sampleData=t.sampleData||{},t.template=t.template||{markup:['<div class="tau-board-unit__value">'+t.id+"</div>"]},"string"==typeof t.template&&(t.template={markup:[t.template]}),"string"==typeof t.template.markup&&(t.template.markup=[t.template.markup]),t.outerClassName&&(t.classId=t.outerClassName),t.isEditable&&(t.interactionConfig={isEditable:t.isEditable},t.editorHandler?t.interactionConfig.handler=t.editorHandler:t.interactionConfig.handler=function(e,n){var r=e.cardDataForUnit,a=t.editorComponentName instanceof Function?t.editorComponentName(r):t.editorComponentName,i=o(a,{});if(t.editorData){var s={};Object.keys(t.editorData).forEach(function(e){var n=t.editorData[e];s[e]=n instanceof Function?n(r):r[n]}),e.cardDataForUnit=s}return i(e,n)}),n.units[t.id]=n.register([t])[t.id]})};t.exports={types:r,sizes:a,add:s}},function(t,e){t.exports=r},function(t,e){t.exports=a},function(t,e){t.exports=o},function(t,e,n){var r=n(13);"string"==typeof r&&(r=[[t.id,r,""]]);n(15)(r,{});r.locals&&(t.exports=r.locals)},function(t,e,n){e=t.exports=n(14)(),e.push([t.id,".mashupCustomUnitShowRelations__svg{position:absolute;top:0;left:0;z-index:99}.mashupCustomUnitShowRelations .i-role-card{opacity:.3}.mashupCustomUnitShowRelations__related,.mashupCustomUnitShowRelations__source{opacity:1!important;background-color:#fff!important;z-index:9;position:relative}.mashupCustomUnitShowRelations__related{outline:pink solid 3px!important}.mashupCustomUnitShowRelations__related-outbound{outline:#7fdbff solid 3px!important}.mashupCustomUnitShowRelations__related-inbound{outline:#0074d9 solid 3px!important}",""])},function(t,e){t.exports=function(){var t=[];return t.toString=function(){for(var t=[],e=0;e<this.length;e++){var n=this[e];n[2]?t.push("@media "+n[2]+"{"+n[1]+"}"):t.push(n[1])}return t.join("")},t.i=function(e,n){"string"==typeof e&&(e=[[null,e,""]]);for(var r={},a=0;a<this.length;a++){var o=this[a][0];"number"==typeof o&&(r[o]=!0)}for(a=0;a<e.length;a++){var i=e[a];"number"==typeof i[0]&&r[i[0]]||(n&&!i[2]?i[2]=n:n&&(i[2]="("+i[2]+") and ("+n+")"),t.push(i))}},t}},function(t,e,n){function r(t,e){for(var n=0;n<t.length;n++){var r=t[n],a=c[r.id];if(a){a.refs++;for(var o=0;o<a.parts.length;o++)a.parts[o](r.parts[o]);for(;o<r.parts.length;o++)a.parts.push(s(r.parts[o],e))}else{for(var i=[],o=0;o<r.parts.length;o++)i.push(s(r.parts[o],e));c[r.id]={id:r.id,refs:1,parts:i}}}}function a(t){for(var e=[],n={},r=0;r<t.length;r++){var a=t[r],o=a[0],i=a[1],s=a[2],u=a[3],l={css:i,media:s,sourceMap:u};n[o]?n[o].parts.push(l):e.push(n[o]={id:o,parts:[l]})}return e}function o(){var t=document.createElement("style"),e=h();return t.type="text/css",e.appendChild(t),t}function i(){var t=document.createElement("link"),e=h();return t.rel="stylesheet",e.appendChild(t),t}function s(t,e){var n,r,a;if(e.singleton){var s=v++;n=m||(m=o()),r=u.bind(null,n,s,!1),a=u.bind(null,n,s,!0)}else t.sourceMap&&"function"==typeof URL&&"function"==typeof URL.createObjectURL&&"function"==typeof URL.revokeObjectURL&&"function"==typeof Blob&&"function"==typeof btoa?(n=i(),r=d.bind(null,n),a=function(){n.parentNode.removeChild(n),n.href&&URL.revokeObjectURL(n.href)}):(n=o(),r=l.bind(null,n),a=function(){n.parentNode.removeChild(n)});return r(t),function(e){if(e){if(e.css===t.css&&e.media===t.media&&e.sourceMap===t.sourceMap)return;r(t=e)}else a()}}function u(t,e,n,r){var a=n?"":r.css;if(t.styleSheet)t.styleSheet.cssText=y(e,a);else{var o=document.createTextNode(a),i=t.childNodes;i[e]&&t.removeChild(i[e]),i.length?t.insertBefore(o,i[e]):t.appendChild(o)}}function l(t,e){var n=e.css,r=e.media;e.sourceMap;if(r&&t.setAttribute("media",r),t.styleSheet)t.styleSheet.cssText=n;else{for(;t.firstChild;)t.removeChild(t.firstChild);t.appendChild(document.createTextNode(n))}}function d(t,e){var n=e.css,r=(e.media,e.sourceMap);r&&(n+="\n/*# sourceMappingURL=data:application/json;base64,"+btoa(unescape(encodeURIComponent(JSON.stringify(r))))+" */");var a=new Blob([n],{type:"text/css"}),o=t.href;t.href=URL.createObjectURL(a),o&&URL.revokeObjectURL(o)}var c={},p=function(t){var e;return function(){return"undefined"==typeof e&&(e=t.apply(this,arguments)),e}},f=p(function(){return/msie [6-9]\b/.test(window.navigator.userAgent.toLowerCase())}),h=p(function(){return document.head||document.getElementsByTagName("head")[0]}),m=null,v=0;t.exports=function(t,e){e=e||{},"undefined"==typeof e.singleton&&(e.singleton=f());var n=a(t);return r(n,e),function(t){for(var o=[],i=0;i<n.length;i++){var s=n[i],u=c[s.id];u.refs--,o.push(u)}if(t){var l=a(t);r(l,e)}for(var i=0;i<o.length;i++){var u=o[i];if(0===u.refs){for(var d=0;d<u.parts.length;d++)u.parts[d]();delete c[u.id]}}}};var y=function(){var t=[];return function(e,n){return t[e]=n,t.filter(Boolean).join("\n")}}()}])})}();
